name: Comment Vercel Error on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  vercel-error-comment:
    runs-on: ubuntu-latest

    steps:
      - name: Get PR info
        env:
          HEAD_REF: ${{ github.head_ref }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          echo "PR_BRANCH=$HEAD_REF" >> $GITHUB_ENV
          echo "PR_SHA=$HEAD_SHA" >> $GITHUB_ENV
          echo "PR_NUMBER=$PR_NUM" >> $GITHUB_ENV

      - name: Get latest Vercel deployment for this PR
        id: get-deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          PR_BRANCH: ${{ env.PR_BRANCH }}
        run: |
          echo "Fetching latest deployment for branch $PR_BRANCH"
          response=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&limit=5")

          # Find the most recent deployment for this PR branch
          DEPLOYMENT_ID=$(echo "$response" | jq -r --arg branch "$PR_BRANCH" \
            '.deployments[] | select(.meta.gitBranch? == $branch) | .uid' | head -n1)

          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "No deployment found for this PR branch."
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found deployment ID: $DEPLOYMENT_ID"
          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV
          echo "found=true" >> $GITHUB_OUTPUT

      - name: Check deployment status
        if: steps.get-deploy.outputs.found == 'true'
        id: check-status
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DEPLOYMENT_ID: ${{ env.DEPLOYMENT_ID }}
        run: |
          echo "Fetching deployment status for ID: $DEPLOYMENT_ID"

          # Fetch deployment data with proper error handling
          response=$(curl -sf -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID")

          if [ $? -ne 0 ]; then
            echo "❌ Error: Failed to fetch deployment status from Vercel API"
            echo "This could be due to network issues, invalid token, or deployment not found"
            exit 1
          fi

          # Extract status from response and verify it's not empty
          status=$(echo "$response" | jq -r '.state // empty')

          if [ -z "$status" ] || [ "$status" = "null" ]; then
            echo "❌ Error: Deployment status is empty or null"
            echo "API Response: $response"
            exit 1
          fi

          echo "✅ Deployment status: $status"
          echo "STATUS=$status" >> $GITHUB_ENV
          echo "status=$status" >> $GITHUB_OUTPUT

      - name: Fetch and comment error logs if deployment failed
        if: steps.check-status.outputs.status == 'ERROR'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DEPLOYMENT_ID: ${{ env.DEPLOYMENT_ID }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Deployment failed. Fetching logs..."

          # Fetch logs with proper error handling
          http_code=$(curl -sf -w "%{http_code}" -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v2/deployments/$DEPLOYMENT_ID/events" \
            -o /tmp/vercel_logs.json 2>/tmp/curl_error.log)
          curl_exit_code=$?

          if [ $curl_exit_code -ne 0 ]; then
            echo "❌ Error: Failed to fetch deployment logs from Vercel API"
            echo "Curl exit code: $curl_exit_code"
            if [ -f /tmp/curl_error.log ]; then
              echo "Curl stderr: $(cat /tmp/curl_error.log)"
            fi
            error_lines="Failed to fetch deployment logs from Vercel API (HTTP $http_code, exit code $curl_exit_code). Please check the deployment logs manually on Vercel dashboard."
          else
            echo "✅ Successfully fetched logs (HTTP $http_code)"
            
            # Verify we have valid JSON
            if ! jq empty /tmp/vercel_logs.json 2>/dev/null; then
              echo "❌ Error: Invalid JSON response from Vercel logs API"
              echo "Response preview: $(head -c 200 /tmp/vercel_logs.json)..."
              error_lines="Received invalid JSON from Vercel logs API. Please check the deployment logs manually on Vercel dashboard."
            else
              # Extract build errors with error handling
              error_lines=$(jq -r '.[] | select(.payload.text | test("Error|Exception|Failed"; "i")) | .payload.text' /tmp/vercel_logs.json 2>/dev/null | tail -n 20)
              
              if [ -z "$error_lines" ]; then
                error_lines="No specific error lines found in deployment logs. Check full logs on Vercel dashboard for more details."
              fi
            fi
          fi

          # Clean up temporary files
          rm -f /tmp/vercel_logs.json /tmp/curl_error.log

          # Post comment on PR
          gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
            -f body="❌ **Vercel Deployment Failed**

          **Error stack:**
          \`\`\`
          $error_lines
          \`\`\`
          [View full logs on Vercel →](https://vercel.com/dashboard/deployments/$DEPLOYMENT_ID)
          "
