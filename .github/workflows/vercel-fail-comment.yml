name: Vercel Deployment Monitor

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  monitor-deployment:
    name: Monitor Vercel Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Setup environment variables
        env:
          HEAD_REF: ${{ github.head_ref }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          echo "PR_BRANCH=$HEAD_REF" >> $GITHUB_ENV
          echo "PR_SHA=$HEAD_SHA" >> $GITHUB_ENV
          echo "PR_NUMBER=$PR_NUM" >> $GITHUB_ENV
          echo "ðŸ“‹ Monitoring deployment for PR #$PR_NUM on branch: $HEAD_REF"

      - name: Wait for Vercel deployment to start
        id: wait-for-deployment
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          echo "ðŸ” Waiting for Vercel deployment to start..."
          
          max_attempts=20  # 10 minutes (30s * 20)
          attempt=0
          deployment_found=false
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "â³ Check $attempt/$max_attempts (waiting for deployment to appear)"
            
            # Build API URL with optional team parameter
            api_url="https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&limit=30"
            if [ -n "$VERCEL_TEAM_ID" ]; then
              api_url="${api_url}&teamId=$VERCEL_TEAM_ID"
            fi
            
            # Fetch recent deployments
            response=$(curl -sf -H "Authorization: Bearer $VERCEL_TOKEN" "$api_url" 2>/tmp/curl_error.log)
            curl_exit=$?
            
            if [ $curl_exit -ne 0 ]; then
              echo "âŒ Failed to fetch deployments from Vercel API (attempt $attempt)"
              if [ -f /tmp/curl_error.log ]; then
                cat /tmp/curl_error.log
              fi
              sleep 30
              continue
            fi
            
            # Look for deployment matching this PR's commit SHA or branch
            deployment_id=$(echo "$response" | jq -r --arg sha "$PR_SHA" --arg branch "$PR_BRANCH" '
              .deployments[]? |
              select(
                (.meta.githubCommitSha? == $sha) or
                (.meta.gitBranch? == $branch)
              ) |
              .uid
            ' | head -n1)
            
            if [ -n "$deployment_id" ]; then
              echo "âœ… Found deployment: $deployment_id"
              
              # Get deployment details
              deploy_info=$(echo "$response" | jq -r --arg id "$deployment_id" '
                .deployments[]? | select(.uid == $id) |
                "Branch: \(.meta.gitBranch // "unknown")\nCommit: \(.meta.githubCommitSha // "unknown")\nState: \(.state)\nURL: \(.url)"
              ')
              
              echo "$deploy_info"
              echo "DEPLOYMENT_ID=$deployment_id" >> $GITHUB_ENV
              deployment_found=true
              break
            fi
            
            echo "â„¹ï¸  No deployment found yet for commit $PR_SHA or branch $PR_BRANCH"
            
            # Show what deployments exist (for debugging)
            if [ $attempt -eq 1 ] || [ $((attempt % 5)) -eq 0 ]; then
              echo "ðŸ“Š Recent deployments in project:"
              echo "$response" | jq -r '.deployments[]? | "\(.uid) - \(.meta.gitBranch // "no-branch") - \(.state)"' | head -5
            fi
            
            sleep 30
          done
          
          if [ "$deployment_found" = false ]; then
            echo "â° Timeout: No deployment found after $max_attempts attempts"
            echo "This could mean:"
            echo "  â€¢ Vercel integration is not configured for this repository"
            echo "  â€¢ Wrong VERCEL_PROJECT_ID in secrets"
            echo "  â€¢ Vercel deployment was not triggered by this PR"
            echo "deployment_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "deployment_found=true" >> $GITHUB_OUTPUT

      - name: Monitor deployment until completion
        id: monitor-deployment
        if: steps.wait-for-deployment.outputs.deployment_found == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          echo "ðŸ”„ Monitoring deployment: $DEPLOYMENT_ID"
          
          max_attempts=30  # 15 minutes (30s * 30)
          attempt=0
          final_state=""
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            
            # Build API URL with optional team parameter
            api_url="https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID"
            if [ -n "$VERCEL_TEAM_ID" ]; then
              api_url="${api_url}?teamId=$VERCEL_TEAM_ID"
            fi
            
            # Fetch deployment status
            response=$(curl -sf -H "Authorization: Bearer $VERCEL_TOKEN" "$api_url" 2>/tmp/curl_error.log)
            curl_exit=$?
            
            if [ $curl_exit -ne 0 ]; then
              echo "âŒ Failed to fetch deployment status (attempt $attempt)"
              if [ -f /tmp/curl_error.log ]; then
                cat /tmp/curl_error.log
              fi
              sleep 30
              continue
            fi
            
            # Extract deployment state
            state=$(echo "$response" | jq -r '.state // empty')
            ready_state=$(echo "$response" | jq -r '.readyState // empty')
            
            if [ -z "$state" ]; then
              echo "âš ï¸  Could not determine deployment state"
              sleep 30
              continue
            fi
            
            echo "ðŸ“Š Status check $attempt/$max_attempts: $state${ready_state:+ ($ready_state)}"
            
            # Check if deployment reached final state
            case "$state" in
              READY)
                echo "âœ… Deployment succeeded!"
                final_state="READY"
                break
                ;;
              ERROR)
                echo "âŒ Deployment failed!"
                final_state="ERROR"
                break
                ;;
              CANCELED)
                echo "ðŸš« Deployment was canceled"
                final_state="CANCELED"
                break
                ;;
              BUILDING|QUEUED|INITIALIZING)
                elapsed=$((attempt * 30))
                echo "â³ Still building... (${elapsed}s elapsed)"
                ;;
              *)
                echo "â„¹ï¸  Current state: $state"
                ;;
            esac
            
            sleep 30
          done
          
          if [ -z "$final_state" ]; then
            echo "â° Timeout: Deployment did not complete within 15 minutes"
            final_state="TIMEOUT"
          fi
          
          echo "DEPLOYMENT_STATE=$final_state" >> $GITHUB_ENV
          echo "deployment_state=$final_state" >> $GITHUB_OUTPUT

      - name: Fetch error logs and post comment
        if: steps.monitor-deployment.outputs.deployment_state == 'ERROR'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“ Fetching deployment error logs..."
          
          # Build API URL with optional team parameter
          api_url="https://api.vercel.com/v2/deployments/$DEPLOYMENT_ID/events"
          if [ -n "$VERCEL_TEAM_ID" ]; then
            api_url="${api_url}?teamId=$VERCEL_TEAM_ID"
          fi
          
          # Fetch deployment events/logs
          events_response=$(curl -sf -H "Authorization: Bearer $VERCEL_TOKEN" "$api_url" -o /tmp/events.json 2>/tmp/curl_error.log)
          curl_exit=$?
          
          if [ $curl_exit -ne 0 ]; then
            echo "âŒ Failed to fetch deployment events"
            if [ -f /tmp/curl_error.log ]; then
              cat /tmp/curl_error.log
            fi
            
            # Create error message in a file to avoid YAML quoting issues
            {
              echo "âš ï¸ **Unable to fetch detailed error logs from Vercel API**"
              echo ""
              echo '```'
              echo "Failed to retrieve deployment events (HTTP error or network issue)"
              echo '```'
              echo ""
              echo "**What to do:**"
              echo "1. Check the [Vercel Dashboard](https://vercel.com/dashboard) for full logs"
              echo "2. View this deployment: https://vercel.com/deployments/$DEPLOYMENT_ID"
              echo "3. Verify VERCEL_TOKEN has correct permissions"
            } > /tmp/error_message.md
            error_message=$(cat /tmp/error_message.md)
          else
            # Validate JSON
            if ! jq empty /tmp/events.json 2>/dev/null; then
              echo "âŒ Invalid JSON response from Vercel events API"
              
              # Create error message in a file to avoid YAML quoting issues
              {
                echo "âš ï¸ **Received invalid response from Vercel API**"
                echo ""
                echo '```'
                echo "Unable to parse deployment events (invalid JSON)"
                echo '```'
                echo ""
                echo "**What to do:**"
                echo "1. Check the [Vercel Dashboard](https://vercel.com/dashboard) for full logs"
                echo "2. View this deployment: https://vercel.com/deployments/$DEPLOYMENT_ID"
              } > /tmp/error_message.md
              error_message=$(cat /tmp/error_message.md)
            else
              echo "âœ… Successfully fetched deployment events"
              
              # Extract error messages from events
              # Look for build errors, exceptions, and failed steps
              error_logs=$(jq -r '
                .[] |
                select(
                  (.type == "stderr") or
                  (.type == "error") or
                  (.payload.text? | test("Error|Exception|Failed|ERROR|FATAL"; "i"))
                ) |
                if .payload.text then
                  .payload.text
                elif .text then
                  .text
                else
                  .payload | tostring
                end
              ' /tmp/events.json 2>/dev/null | grep -v "^null$" || echo "")
              
              # If no specific errors found, get the last build output
              if [ -z "$error_logs" ]; then
                echo "â„¹ï¸  No specific error messages found, extracting build output..."
                error_logs=$(jq -r '
                  .[] |
                  select(.type == "stdout" or .type == "stderr") |
                  .payload.text // .text // empty
                ' /tmp/events.json 2>/dev/null | tail -50 || echo "")
              fi
              
              # Limit output to last 100 lines to avoid huge comments
              if [ -n "$error_logs" ]; then
                error_logs=$(echo "$error_logs" | tail -100)
              else
                error_logs="No detailed error messages found in deployment logs.
Please check the Vercel dashboard for complete build output."
              fi
              
              # Get deployment URL
              deploy_url=$(curl -sf -H "Authorization: Bearer $VERCEL_TOKEN" \
                "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID" | \
                jq -r '.url // empty')
              
              # Construct error message in a file to avoid YAML quoting issues
              {
                echo "## ðŸš¨ Vercel Deployment Failed"
                echo ""
                echo "**Deployment ID:** \`$DEPLOYMENT_ID\`"
                echo "**Branch:** \`$PR_BRANCH\`"
                echo "**Commit:** \`${PR_SHA:0:7}\`"
                if [ -n "$deploy_url" ]; then
                  echo "**Preview URL:** https://$deploy_url"
                fi
                echo ""
                echo "---"
                echo ""
                echo "### ðŸ“‹ Error Stack Trace"
                echo ""
                echo '```'
                echo "$error_logs"
                echo '```'
                echo ""
                echo "---"
                echo ""
                echo "### ðŸ”— Useful Links"
                echo ""
                echo "- [View Full Logs on Vercel](https://vercel.com/deployments/$DEPLOYMENT_ID)"
                echo "- [Vercel Dashboard](https://vercel.com/dashboard)"
                echo "- [Deployment Events API](https://vercel.com/docs/rest-api/endpoints#get-deployment-events)"
                echo ""
                echo "### ðŸ’¡ Next Steps"
                echo ""
                echo "1. Review the error stack trace above"
                echo "2. Fix the issues in your code"
                echo "3. Push new commits to trigger a new deployment"
                echo "4. Check Vercel dashboard for additional context"
                echo ""
                echo "---"
                echo ""
                echo "<sub>ðŸ¤– This comment was automatically generated by the Vercel Deployment Monitor workflow</sub>"
              } > /tmp/error_message.md
              error_message=$(cat /tmp/error_message.md)
            fi
          fi
          
          # Clean up temporary files
          rm -f /tmp/events.json /tmp/curl_error.log
          
          # Post comment to PR using GitHub CLI
          echo "$error_message" > /tmp/comment.md
          
          echo "ðŸ“¤ Posting comment to PR #$PR_NUMBER..."
          gh pr comment "$PR_NUMBER" --body-file /tmp/comment.md --repo "${{ github.repository }}"
          
          if [ $? -eq 0 ]; then
            echo "âœ… Successfully posted error details to PR"
          else
            echo "âŒ Failed to post comment to PR"
            exit 1
          fi
          
          rm -f /tmp/comment.md

      - name: Report timeout
        if: steps.monitor-deployment.outputs.deployment_state == 'TIMEOUT'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â° Posting timeout notice to PR..."
          
          # Create timeout message in a file to avoid YAML quoting issues
          {
            echo "## â° Vercel Deployment Timeout"
            echo ""
            echo "**Deployment ID:** \`$DEPLOYMENT_ID\`"
            echo "**Branch:** \`$PR_BRANCH\`"
            echo ""
            echo "The deployment did not complete within the 15-minute monitoring window."
            echo ""
            echo "### What this means:"
            echo ""
            echo "- The deployment may still be in progress"
            echo "- It could be stuck in a long build process"
            echo "- There may be an issue with Vercel's platform"
            echo ""
            echo "### What to do:"
            echo ""
            echo "1. Check the [Vercel Dashboard](https://vercel.com/deployments/$DEPLOYMENT_ID) to see current status"
            echo "2. If stuck, try canceling and re-triggering the deployment"
            echo "3. Consider optimizing your build process if builds consistently take >15 minutes"
            echo ""
            echo "---"
            echo ""
            echo "<sub>ðŸ¤– This comment was automatically generated by the Vercel Deployment Monitor workflow</sub>"
          } > /tmp/timeout_message.md
          
          gh pr comment "$PR_NUMBER" --body-file /tmp/timeout_message.md --repo "${{ github.repository }}"
          rm -f /tmp/timeout_message.md

      - name: Report success
        if: steps.monitor-deployment.outputs.deployment_state == 'READY'
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "No comment needed - deployment succeeded"
